---
title: "H_W_2"
author: "Tumova M.A."
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plotly)
library(rstatix)
library(ggpubr)
library(corrplot)
library(factoextra)
library(pheatmap)
library(ggbiplot)
library(tidymodels)
library(embed)
library(dplyr)
library(ggplot2)
theme_set(theme_minimal())
```

## Read data

```{r cars}
data <- readRDS("life_expectancy_data.RDS")
```

## Plotly

```{r pressure, echo=FALSE}
plot_ly(data,
        x = ~`Life expectancy`,
        y = ~`Sucide Rate`,
        color = ~continent,
        type = "scatter")
```

## Life expectancy_data America vs Africa

```{r}
# stat.test <- data %>% filter(continent %in% c('Africa', 'Americas')) %>%t_test(`Life expectancy` ~ continent) %>% add_xy_position(x = "continent") 
# stat.test

# data %>% filter(continent %in% c('Africa', 'Americas')) %>% ggboxplot(x = "continent", y = "Life expectancy", ylab = "Life expectancy", xlab = "continent", add = "jitter") +  labs(subtitle = get_test_label(stat.test, detailed = TRUE)) + stat_pvalue_manual(stat.test, tip.length = 0) 

```
## Corrplot
```{r}
new_data <- data %>% select(!Year) %>% select(where(is.numeric))
data_cor <- cor(new_data) 
data_cor

corrplot(data_cor)

corrplot(data_cor, method = "color", type = "lower", 
         addCoef.col = "grey30", diag = FALSE,
         cl.pos = "b", tl.col = "grey10",
         col = COL2('RdBu', 10))

```

## Hierarchical clustering

```{r}
new_data_scaled <- scale(new_data)

new_data_dist <- dist(new_data_scaled, 
                        method = "euclidean"
                        )
as.matrix(new_data_dist)[1:7,1:7]

new_data_hc <- hclust(d = new_data_dist, 
                        method = "ward.D2")

fviz_dend(new_data_hc, 
          cex = 0.1)

pheatmap(
  new_data_scaled,
  show_rownames = FALSE,
  clustering_distance_rows = new_data_dist,
  clustering_method = "ward.D2",
  cutree_rows = 5,
  cutree_cols = length(colnames(new_data_scaled)),
  angle_col = 45,
  main = "Dendrograms for clustering rows and columns with map"
)
```
# На основе дендрограммы кластеризации было выделено 5 кластеров,кроме того мы упорядочили колонки так, чтобы похожие колонки были ближе друг к другу, красным отмечены более высокие значения, а голубым - более низкие. Так стобцы GDP и GNI в 3 кластере включают больше наблюдений.

## PCA analysis

```{r}
new_data_pca <- prcomp(new_data_scaled, 
                scale = F)
new_data_pca$rotation


```
PC1, PC2, ..., PC19 - это главные компоненты, и каждый столбец отражает вклад каждой переменной в данный компонент. Значения в каждой строке представляют собой вес или вклад соответствующей переменной в соответствующий главный компонент. Положительные и отрицательные значения указывают на направление влияния. Переменные с более высокими абсолютными значениями вносят больший вклад в главный компонент.

## Biplot
```{r}
ggbiplot(new_data_pca, 
         groups = as.factor(data$continent), 
         ellipse = T,
         scale=0, alpha = 0.1) + 
  theme_minimal()
```

## Дайте содержательную интерпретацию PCA анализу.

```{r}
summary(new_data_pca)
fviz_contrib(new_data_pca, choice = "var", axes = 1, top = 24) # 1
fviz_contrib(new_data_pca, choice = "var", axes = 2, top = 24) # 2
fviz_contrib(new_data_pca, choice = "var", axes = 3, top = 24) # 3

fviz_pca_var(new_data_pca, 
             select.var = list(contrib = 3), # Задаём число здесь 
             col.var = "contrib")

```
# Первые 3 компоненты объясняют 61,7% выриации данных.

## Сравнение результатов отображения точек между алгоритмами PCA и UMAP.

```{r}
umap_data <- recipe(~., data = new_data) %>% 
  step_normalize(all_predictors()) %>%
  step_umap(all_predictors()) %>%  
  prep() %>% 
  juice() 

umap_data %>%
  ggplot(aes(UMAP1,  2)) + #  # можно добавить раскраску 
  geom_point(aes(color = data$continent), 
             alpha = 0.7, size = 2) +
  labs(color = NULL) 

```

